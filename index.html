<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pro Forex Position Sizer — Premium</title>
  <meta name="description" content="Premium Forex position sizing tool — lot sizing, pip values, risk management, journal, PDF/CSV export. No API keys required." />

  <!-- Minimal favicon (data URI) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect rx=%2220%22 width=%22100%22 height=%22100%22 fill=%22%237c3aed%22/><text x=%2250%22 y=%2258%22 font-size=%2246%22 text-anchor=%22middle%22 fill=%22white%22 font-family=%22Arial%22 font-weight=%22700%22>FX</text></svg>">

  <!-- jsPDF CDN (used for PDF exports) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
  /* ---------- Design tokens ---------- */
  :root{
    --bg-1: #f4f7fb;
    --bg-2: #eef4ff;
    --card: #ffffff;
    --muted: #6b7280;
    --accent-a: #6c5ce7; /* purple */
    --accent-b: #00c2ff; /* cyan */
    --glass: rgba(255,255,255,0.7);
    --radius-lg: 18px;
    --radius-md: 10px;
    --shadow-soft: 0 12px 40px rgba(15, 23, 42, 0.08);
    --success: #10b981;
    --danger: #ef4444;
  }

  /* ---------- Reset ---------- */
  * { box-sizing: border-box; }
  html,body { height:100%; }
  body {
    margin:0;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    background:
      radial-gradient(600px 400px at 10% 10%, rgba(124,58,237,0.06), transparent 10%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color: #0f172a;
    padding: 36px;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  /* ---------- Layout: shell ---------- */
  .shell {
    width:100%;
    max-width:1200px;
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:28px;
    align-items:start;
  }
  @media (max-width:1000px){ .shell{grid-template-columns:1fr; padding:0 12px} }

  /* ---------- Main card ---------- */
  .card {
    background: var(--card);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow-soft);
    padding:28px;
    border: 1px solid rgba(124,58,237,0.06);
  }
  header.app-header { display:flex; align-items:center; gap:14px; margin-bottom:14px; }
  .logo {
    width:64px; height:64px; border-radius:12px;
    background: linear-gradient(135deg,var(--accent-a),var(--accent-b));
    display:flex; align-items:center; justify-content:center; color:white; font-weight:800;
    font-size:20px; box-shadow: 0 14px 40px rgba(92, 71, 192, 0.12);
    flex-shrink:0;
  }
  h1 { margin:0; font-size:1.25rem; letter-spacing: -0.01em; }
  p.lead { margin:0; color:var(--muted); font-size:.95rem; }

  /* ---------- Form layout ---------- */
  .grid {
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:12px;
    margin-top:14px;
  }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  label { display:block; font-weight:600; margin-bottom:6px; color:#0f172a; font-size:0.92rem; }
  .field { margin-bottom:14px; }
  input[type="number"], select, textarea {
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid #e6eef8;
    font-size:1rem; background:linear-gradient(180deg,#fff,#fcfeff);
    color:#0f172a; outline:none; transition:box-shadow .12s, transform .06s;
  }
  input[type="number"]:focus, select:focus, textarea:focus {
    box-shadow: 0 10px 30px rgba(14,165,233,0.06);
    transform: translateY(-1px);
    border-color: rgba(14,165,233,0.2);
  }
  .muted { color:var(--muted); font-size:.9rem; }

  .actions { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
  button.btn { padding:12px 14px; border-radius:12px; border:0; font-weight:800; cursor:pointer; color:white;
    background: linear-gradient(90deg,var(--accent-a),var(--accent-b)); box-shadow: 0 12px 30px rgba(124,58,237,0.10);
    transition: transform .08s ease; }
  button.btn:active { transform: translateY(1px); }
  button.ghost { background:transparent; border:1px solid rgba(14,165,233,0.08); color:var(--accent-a); font-weight:700; }
  button.ghost:active { transform:translateY(1px); }

  /* ---------- Result area ---------- */
  .result-card { margin-top:18px; background: linear-gradient(180deg,#ffffff,#fbfdff); border-radius:12px; padding:14px; border:1px solid rgba(14,165,233,0.04); }
  .result-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .result-row { padding:10px; border-radius:8px; background: linear-gradient(180deg,#fff,#f7fbff); display:flex; justify-content:space-between; align-items:center; }
  .result-key { color:#475569; font-weight:700; font-size:0.92rem; }
  .result-val { font-weight:800; color:#0f172a; text-align:right; }

  .small { font-size:.85rem; color:var(--muted); }

  /* ---------- Right column ---------- */
  aside.side { display:flex; flex-direction:column; gap:18px; }
  .card.side-card { padding:18px; border-radius:12px; background:linear-gradient(180deg,#fff,#fcfeff); border:1px solid rgba(124,58,237,0.03); box-shadow: 0 8px 18px rgba(15,23,42,0.03); }

  .journal-list { max-height:360px; overflow:auto; margin-top:12px; }
  .trade-item { display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(14,165,233,0.04); margin-bottom:8px; align-items:center; }
  .trade-left { font-weight:700; }
  .trade-meta { color:var(--muted); font-size:.86rem; }

  .rates textarea { width:100%; min-height:110px; padding:10px; border-radius:8px; border:1px solid #e6eef8; resize:vertical; font-family:monospace; font-size:.92rem; }

  footer.tiny { color:var(--muted); font-size:.85rem; margin-top:8px; }

  /* ---------- small helpers ---------- */
  .tooltip { position:relative; display:inline-block; cursor:help; color:var(--muted); font-size:.9rem; margin-left:8px; }
  .tooltip .tip { position:absolute; bottom:120%; left:50%; transform:translateX(-50%); background:#0f172a; color:#fff; padding:8px 10px; border-radius:8px; white-space:nowrap; font-size:.82rem; display:none; }
  .tooltip:hover .tip, .tooltip:focus .tip { display:block; }

  /* ---------- responsive ---------- */
  @media (max-width:640px){
    .result-grid{ grid-template-columns:1fr; }
    .logo{width:52px;height:52px}
  }
  </style>
</head>
<body>
  <div class="shell">
    <!-- Left: Main -->
    <main class="card" role="main" aria-labelledby="appTitle">
      <header class="app-header">
        <div class="logo" aria-hidden="true">FX</div>
        <div>
          <h1 id="appTitle">Pro Forex Position Sizer</h1>
          <p class="lead">Sleek lot sizing, pip value & risk management — journal, PDF & CSV export. No keys required.</p>
        </div>
      </header>

      <form id="calcForm" onsubmit="return false" aria-describedby="formHelp">
        <div id="formHelp" class="small muted">Enter the values below — results update live while typing. Click <strong>Calculate</strong> to lock results.</div>

        <div class="grid" style="margin-top:14px;">
          <div class="field">
            <label for="accountCurrency">Account Currency
              <span class="tooltip" tabindex="0">ⓘ<span class="tip">Currency of your trading account. Affects pip value display.</span></span>
            </label>
            <select id="accountCurrency" aria-label="Account currency">
              <option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="JPY">JPY</option>
              <option value="AUD">AUD</option><option value="CAD">CAD</option><option value="CHF">CHF</option><option value="NZD">NZD</option>
            </select>
          </div>

          <div class="field">
            <label for="pair">Currency Pair</label>
            <select id="pair" aria-label="Currency pair">
              <option value="EURUSD">EUR / USD</option>
              <option value="GBPUSD">GBP / USD</option>
              <option value="USDJPY">USD / JPY</option>
              <option value="AUDUSD">AUD / USD</option>
              <option value="USDCAD">USD / CAD</option>
              <option value="USDCHF">USD / CHF</option>
              <option value="NZDUSD">NZD / USD</option>
              <option value="EURGBP">EUR / GBP</option>
              <option value="EURJPY">EUR / JPY</option>
              <option value="GBPJPY">GBP / JPY</option>
              <option value="AUDJPY">AUD / JPY</option>
              <option value="GBPCHF">GBP / CHF</option>
              <option value="USDSGD">USD / SGD</option>
              <option value="EURCAD">EUR / CAD</option>
            </select>
          </div>
        </div>

        <div class="grid" style="margin-top:6px;">
          <div class="field">
            <label for="balance">Account Balance</label>
            <input id="balance" type="number" inputmode="decimal" min="0" step="any" placeholder="e.g., 10000" />
          </div>
          <div class="field">
            <label for="riskPercent">Risk % per Trade</label>
            <input id="riskPercent" type="number" inputmode="decimal" min="0.01" max="100" step="any" placeholder="e.g., 1" />
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label for="stopLoss">Stop Loss (pips)</label>
            <input id="stopLoss" type="number" inputmode="decimal" min="0.1" step="any" placeholder="e.g., 25" />
          </div>
          <div class="field">
            <label for="takeProfit">Take Profit (pips — optional)</label>
            <input id="takeProfit" type="number" inputmode="decimal" min="0" step="any" placeholder="Leave blank if none" />
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label for="leverage">Leverage (optional)</label>
            <input id="leverage" type="number" min="1" step="1" placeholder="e.g., 100" />
          </div>
          <div class="field">
            <label for="slippage">Slippage (pips — optional)</label>
            <input id="slippage" type="number" min="0" step="any" placeholder="e.g., 0.5" />
          </div>
        </div>

        <div style="margin-top:6px;" class="small muted">Tip: leave optional fields blank if you don't want to use them. Take Profit is optional.</div>

        <div class="actions" style="margin-top:12px;">
          <button id="calcBtn" class="btn" type="button" title="Run calculation">Calculate</button>
          <button id="liveToggle" class="ghost" type="button" title="Toggle live updates">Live: On</button>
          <button id="saveBtn" class="ghost" type="button" title="Save last calculation">Save Trade</button>
        </div>

        <div id="resultArea" class="result-card" style="display:none;" aria-live="polite" aria-atomic="true">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="small muted">Latest calculation</div>
            <div class="small muted" id="whenStamp"></div>
          </div>

          <div class="result-grid">
            <div class="result-row"><div class="result-key">Lot Size (Standard)</div><div class="result-val" id="resLot">—</div></div>
            <div class="result-row"><div class="result-key">Mini / Micro</div><div class="result-val" id="resMini">—</div></div>

            <div class="result-row"><div class="result-key">Risk Amount</div><div class="result-val" id="resRisk">—</div></div>
            <div class="result-row"><div class="result-key">Pip Value</div><div class="result-val" id="resPip">—</div></div>

            <div class="result-row"><div class="result-key">Potential Profit</div><div class="result-val" id="resProfit">—</div></div>
            <div class="result-row"><div class="result-key">Risk : Reward</div><div class="result-val" id="resRR">—</div></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="ghost" id="copyBtn">Copy</button>
            <button class="ghost" id="emailBtn">Email</button>
            <button class="ghost" id="pdfBtn">Export PDF</button>
            <button class="ghost" id="downloadPage">Download HTML</button>
          </div>
        </div>

      </form>

      <div class="tiny" style="margin-top:12px">All calculations done client-side. You can edit FX rates in Settings (right column) — no API keys required.</div>
    </main>

    <!-- Right: Journal & Settings -->
    <aside class="side">
      <section class="card side-card" aria-labelledby="journalTitle">
        <h3 id="journalTitle" style="margin:0 0 6px 0">Trade Journal</h3>
        <div class="small muted">Saved locally to this browser. Export CSV/PDF anytime.</div>
        <div class="journal-list" id="journalList" aria-live="polite"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="exportCsvBtn">Export CSV</button>
          <button class="ghost" id="exportJournalPdf">Export PDF</button>
        </div>
      </section>

      <section class="card side-card" aria-labelledby="settingsTitle">
        <h3 id="settingsTitle" style="margin:0 0 6px 0">Settings & FX Rates</h3>
        <div class="small muted">Paste or edit FX rates (JSON). Format: <code>{ "USD": 1, "EUR": 0.92, "JPY": 134.5 }</code></div>
        <div style="margin-top:8px">
          <textarea id="ratesArea" class="rates" aria-label="FX rates JSON"></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="loadRatesBtn">Load Rates</button>
          <button class="ghost" id="resetRatesBtn">Reset</button>
        </div>

        <div style="margin-top:12px" class="small muted">Precision & other controls</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="ghost" id="prec4">Precision 4</button>
          <button class="ghost" id="prec6">Precision 6</button>
        </div>
      </section>
    </aside>
  </div>

<script>
/* =========================
   Premium Forex Sizer
   Single-file, production-ready
   No API keys
   ========================= */

/* ---------- Defaults & state ---------- */
const DEFAULT_RATES = { USD:1, EUR:0.92, GBP:0.79, JPY:134.5, AUD:1.46, CAD:1.34, CHF:0.92, NZD:1.56, SGD:1.35 };
let fxRates = Object.assign({}, DEFAULT_RATES);
let liveUpdate = true;
let displayPrecision = 4;
let lastCalc = null;

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const nowIso = () => new Date().toISOString();
function isEmpty(v){ return v === null || v === undefined || v === ''; }
function isJPYPair(pair){ return pair.toUpperCase().endsWith('JPY'); }
function fmt(n, p = displayPrecision){ if(typeof n !== 'number' || isNaN(n)) return '-'; return Number(n).toFixed(p); }

/* currency formatting with Intl if available */
function currencyFormat(amount, currency = 'USD'){
  try{
    const opts = { style:'currency', currency, minimumFractionDigits: (currency==='JPY'?0:2) };
    return new Intl.NumberFormat('en-US', opts).format(amount);
  } catch(e){
    return (currency==='JPY') ? `${amount.toFixed(0)} ${currency}` : `${amount.toFixed(2)} ${currency}`;
  }
}

/* ---------- Pip value estimation ---------- */
/* Using fxRates as map: currency -> number representing units per USD (1 USD = fxRates[currency])
   We compute quote currency -> USD as 1 / fxRates[quote]
   pip size: .0001 for most, .01 for JPY pairs
   pip value per 1 standard lot (100,000 units) in USD = pipSize * 100000 * quoteToUSD
*/
function estimatePipValueUSD(pair){
  pair = pair.toUpperCase();
  if(pair.length !== 6) return 10;
  const base = pair.slice(0,3), quote = pair.slice(3,6);
  const pipSize = isJPYPair(pair) ? 0.01 : 0.0001;
  const quoteRate = fxRates[quote] ? fxRates[quote] : 1;
  const quoteToUSD = 1 / quoteRate;
  const pipValueUSD = pipSize * 100000 * quoteToUSD;
  return pipValueUSD;
}

/* ---------- Calculation ---------- */
function calculateFromInputs({ accountCurrency, pair, balance, riskPercent, stopLoss, takeProfit, leverage, slippage }){
  // validations are done before calling
  const pipValueUSD = estimatePipValueUSD(pair);
  // convert USD pip value to account currency units: pipValueUSD * (units per USD in account currency)
  const accRate = fxRates[accountCurrency] ? fxRates[accountCurrency] : 1; // 1 USD = accRate units
  const pipValueAccount = pipValueUSD * accRate;

  const riskAmount = balance * (riskPercent / 100);
  const effectiveStop = Number(stopLoss) + (Number(slippage) || 0);

  let lotSize = riskAmount / (effectiveStop * pipValueAccount);

  // leverage cap (approximate margin cap) - optional
  if(leverage && Number(leverage) > 0){
    // approximate notional per 1 lot in USD = 100,000 (simplification)
    const notionalUSD = 100000;
    const notionalAccount = notionalUSD * accRate;
    const marginPerLot = notionalAccount / Number(leverage);
    const maxLotsByMargin = balance / marginPerLot;
    if(maxLotsByMargin < lotSize){
      // cap to maximum affordable by margin
      lotSize = Math.max(0, maxLotsByMargin);
      // note: we will surface a note to user if cap applied
    }
  }

  const mini = lotSize * 10;
  const micro = lotSize * 100;

  let potentialProfit = null;
  if(takeProfit !== null && takeProfit !== '' && !isNaN(Number(takeProfit))){
    potentialProfit = lotSize * Number(takeProfit) * pipValueAccount;
  }

  let rr = null;
  if(potentialProfit !== null){
    rr = (potentialProfit / riskAmount);
  }

  return {
    timestamp: nowIso(),
    accountCurrency, pair, balance, riskPercent, stopLoss, takeProfit: (takeProfit==='')?null:takeProfit,
    slippage: slippage || 0, leverage: leverage || null,
    pipValueUSD, pipValueAccount, lotSize, mini, micro, riskAmount, potentialProfit, rr
  };
}

/* ---------- UI update helpers ---------- */
function showResult(calc){
  $('resultArea').style.display = 'block';
  $('resLot').textContent = `${fmt(calc.lotSize)} lots`;
  $('resMini').textContent = `${fmt(calc.mini)} / ${fmt(calc.micro)}`;
  $('resRisk').textContent = currencyFormat(calc.riskAmount, calc.accountCurrency);
  $('resPip').textContent = `${currencyFormat(calc.pipValueAccount, calc.accountCurrency)} / pip`;
  $('resProfit').textContent = calc.potentialProfit ? currencyFormat(calc.potentialProfit, calc.accountCurrency) : 'N/A';
  $('resRR').textContent = (calc.rr===null || calc.rr===undefined) ? 'N/A' : `${Number(calc.rr).toFixed(2)} : 1`;
  $('whenStamp').textContent = new Date(calc.timestamp).toLocaleString();

  // store lastCalc
  lastCalc = calc;
  sessionStorage.setItem('fx_last_calc', JSON.stringify(calc));
}

/* ---------- Input reading & live debounce ---------- */
let liveTimer = null;
const DEBOUNCE_MS = 350;

function readInputs(){
  return {
    accountCurrency: $('accountCurrency').value,
    pair: $('pair').value,
    balance: Number($('balance').value) || 0,
    riskPercent: Number($('riskPercent').value) || 0,
    stopLoss: Number($('stopLoss').value) || 0,
    takeProfit: $('takeProfit').value.trim(),
    leverage: $('leverage').value.trim(),
    slippage: $('slippage').value.trim()
  };
}

function validateInputs(inputs){
  if(!inputs.balance || inputs.balance <= 0) return 'Please enter a positive account balance.';
  if(!inputs.riskPercent || inputs.riskPercent <= 0 || inputs.riskPercent > 100) return 'Risk % must be between 0.01 and 100.';
  if(!inputs.stopLoss || inputs.stopLoss <= 0) return 'Please enter a positive stop loss (pips).';
  if(inputs.takeProfit !== '' && (isNaN(Number(inputs.takeProfit)) || Number(inputs.takeProfit) < 0)) return 'Take profit must be a positive number or left blank.';
  if(inputs.leverage !== '' && (isNaN(Number(inputs.leverage)) || Number(inputs.leverage) < 1)) return 'Leverage must be a positive integer or left blank.';
  if(inputs.slippage !== '' && (isNaN(Number(inputs.slippage)) || Number(inputs.slippage) < 0)) return 'Slippage must be a non-negative number or left blank.';
  return '';
}

function runCalcUI(){
  const inputs = readInputs();
  const err = validateInputs(inputs);
  $('error').textContent = err || '';
  if(err) return;

  const calc = calculateFromInputs(inputs);
  showResult(calc);
}

/* ---------- Live update binding ---------- */
function setupLiveUpdates(){
  const inputs = ['balance','riskPercent','stopLoss','takeProfit','slippage','leverage','pair','accountCurrency'];
  inputs.forEach(id=>{
    const el = $(id);
    el.addEventListener('input', ()=> {
      if(!liveUpdate) return;
      if(liveTimer) clearTimeout(liveTimer);
      liveTimer = setTimeout(()=> runCalcUI(), DEBOUNCE_MS);
    });
    // update on change for selects
    el.addEventListener('change', ()=> { if(liveUpdate) runCalcUI(); });
  });

  $('liveToggle').addEventListener('click', ()=>{
    liveUpdate = !liveUpdate;
    $('liveToggle').textContent = `Live: ${liveUpdate? 'On' : 'Off'}`;
  });
}

/* ---------- Buttons ---------- */
$('calcBtn').addEventListener('click', ()=> {
  runCalcUI();
  // after calculation, focus copy btn for accessibility
  if(lastCalc) setTimeout(()=> $('copyBtn').focus(), 40);
});

$('copyBtn').addEventListener('click', ()=> {
  if(!lastCalc){ alert('No result to copy.'); return; }
  const txt = composeResultText(lastCalc);
  navigator.clipboard.writeText(txt).then(()=> {
    alert('Copied to clipboard.');
  }).catch(()=> {
    alert('Copy failed. You can manually select the results and copy.');
  });
});

$('emailBtn').addEventListener('click', ()=> {
  if(!lastCalc){ alert('No result to email.'); return; }
  const subject = encodeURIComponent('Forex calculation result');
  const body = encodeURIComponent(composeResultText(lastCalc));
  const mailto = `mailto:?subject=${subject}&body=${body}`;
  // try open
  const opened = window.open(mailto);
  if(!opened){ const a = document.createElement('a'); a.href = mailto; a.click(); }
});

$('pdfBtn').addEventListener('click', ()=> {
  if(!lastCalc){ alert('No result to export.'); return; }
  downloadCalcPDF(lastCalc);
});

$('downloadPage').addEventListener('click', ()=> {
  const html = '<!doctype html>\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'forex_sizer.html'; a.click();
  URL.revokeObjectURL(url);
});

/* ---------- Calculation & export utilities ---------- */
function composeResultText(calc){
  return `Forex Calculation (${new Date(calc.timestamp).toLocaleString()}):
Pair: ${calc.pair}
Account Currency: ${calc.accountCurrency}
Balance: ${calc.balance}
Risk %: ${calc.riskPercent}%
Stop Loss: ${calc.stopLoss} pips
Slippage: ${calc.slippage} pips
Leverage: ${calc.leverage || 'N/A'}
Lot Size (standard): ${fmt(calc.lotSize)} lots
Mini / Micro: ${fmt(calc.mini)} / ${fmt(calc.micro)}
Risk Amount: ${currencyFormat(calc.riskAmount, calc.accountCurrency)}
Pip Value (acct): ${currencyFormat(calc.pipValueAccount, calc.accountCurrency)} per pip
Potential Profit: ${calc.potentialProfit ? currencyFormat(calc.potentialProfit, calc.accountCurrency) : 'N/A'}
Risk:Reward: ${calc.rr ? (Number(calc.rr).toFixed(2) + ' : 1') : 'N/A'}
`;
}

/* PDF export for single calc */
function downloadCalcPDF(calc){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  // Header
  doc.setFillColor(124,58,231);
  doc.rect(0,0,595,60,'F');
  doc.setFontSize(18);
  doc.setTextColor(255,255,255);
  doc.text('Forex Position Size Report', 40, 40);

  doc.setFontSize(11);
  doc.setTextColor(20,20,20);
  let y = 90;
  const addLine = (k,v)=> { doc.setFont(undefined,'bold'); doc.text(k,40,y); doc.setFont(undefined,'normal'); doc.text(String(v),260,y); y+=18; };

  addLine('Date', new Date(calc.timestamp).toLocaleString());
  addLine('Pair', calc.pair);
  addLine('Account Currency', calc.accountCurrency);
  addLine('Account Balance', currencyFormat(calc.balance, calc.accountCurrency));
  addLine('Risk %', calc.riskPercent + ' %');
  addLine('Stop Loss (pips)', calc.stopLoss);
  addLine('Slippage (pips)', calc.slippage || 0);
  addLine('Leverage', calc.leverage || 'N/A');
  addLine('Lot Size (standard)', fmt(calc.lotSize));
  addLine('Mini / Micro', fmt(calc.mini) + ' / ' + fmt(calc.micro));
  addLine('Risk Amount', currencyFormat(calc.riskAmount, calc.accountCurrency));
  addLine('Pip Value (acct)', currencyFormat(calc.pipValueAccount, calc.accountCurrency));
  addLine('Potential Profit', calc.potentialProfit ? currencyFormat(calc.potentialProfit, calc.accountCurrency) : 'N/A');
  addLine('Risk:Reward', calc.rr ? Number(calc.rr).toFixed(2) + ' : 1' : 'N/A');

  doc.save('fx_calculation.pdf');
}

/* ---------- Journal (localStorage) ---------- */
function loadJournal(){
  try{
    return JSON.parse(localStorage.getItem('fx_journal_v2') || '[]');
  }catch(e){ return []; }
}
function saveJournal(list){ localStorage.setItem('fx_journal_v2', JSON.stringify(list)); renderJournal(); }

function saveLastTrade(){
  if(!lastCalc){ alert('No calculation to save.'); return; }
  const list = loadJournal();
  list.push(lastCalc);
  saveJournal(list);
  alert('Trade saved locally.');
}

$('saveBtn').addEventListener('click', saveLastTrade);

function renderJournal(){
  const list = loadJournal();
  const container = $('journalList');
  container.innerHTML = '';
  if(list.length === 0){ container.innerHTML = '<div class="small muted">No saved trades yet.</div>'; return; }
  list.slice().reverse().forEach(entry=>{
    const item = document.createElement('div'); item.className='trade-item';
    const left = document.createElement('div'); left.innerHTML = `<div class="trade-left">${entry.pair} • ${fmt(entry.lotSize)} lots</div><div class="trade-meta">${entry.accountCurrency} • ${new Date(entry.timestamp).toLocaleString()}</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div class="small muted">${currencyFormat(entry.riskAmount, entry.accountCurrency)}</div><div style="margin-top:8px"><button class="ghost" onclick='deleteTrade("${entry.timestamp}")'>Delete</button></div>`;
    item.appendChild(left); item.appendChild(right); container.appendChild(item);
  });
}
function deleteTrade(timestamp){
  let list = loadJournal();
  list = list.filter(t => t.timestamp !== timestamp);
  saveJournal(list);
}

$('exportCsvBtn').addEventListener('click', ()=>{
  const list = loadJournal();
  if(list.length === 0){ alert('No trades to export.'); return; }
  const headers = ['timestamp','pair','accountCurrency','balance','riskPercent','stopLoss','slippage','leverage','lotSize','mini','micro','riskAmount','pipValueAccount','potentialProfit','rr'];
  const rows = list.map(r => headers.map(h => JSON.stringify(r[h]===undefined? '' : r[h])).join(','));
  const csv = [headers.join(',')].concat(rows).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'fx_journal.csv'; a.click(); URL.revokeObjectURL(url);
});

$('exportJournalPdf').addEventListener('click', ()=>{
  const list = loadJournal();
  if(list.length === 0){ alert('No trades to export.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  doc.setFontSize(16); doc.text('FX Trade Journal', 40, 40);
  doc.setFontSize(11);
  let y = 70;
  list.slice().reverse().forEach(t => {
    const txt = `${new Date(t.timestamp).toLocaleString()} • ${t.pair} • ${fmt(t.lotSize)} lots • ${currencyFormat(t.riskAmount, t.accountCurrency)}`;
    doc.text(txt, 40, y); y += 16;
    if(y > 760) { doc.addPage(); y = 40; }
  });
  doc.save('fx_journal.pdf');
});

/* ---------- Load / Reset Rates ---------- */
$('loadRatesBtn').addEventListener('click', ()=>{
  const val = $('ratesArea').value.trim();
  if(!val){ alert('Paste valid JSON rates first.'); return; }
  try{
    const parsed = JSON.parse(val);
    for(const k in parsed){ if(isNaN(Number(parsed[k]))){ alert('Rate values must be numbers.'); return; } }
    fxRates = Object.assign({}, DEFAULT_RATES, parsed);
    alert('Rates loaded.');
  }catch(e){ alert('Invalid JSON. Example: { "USD":1, "EUR":0.92, "JPY":134.5 }'); }
  // refresh calculation if visible
  if(lastCalc) runCalcUI();
});

$('resetRatesBtn').addEventListener('click', ()=>{
  fxRates = Object.assign({}, DEFAULT_RATES);
  $('ratesArea').value = JSON.stringify(fxRates, null, 2);
  alert('Rates reset.');
});

$('prec4').addEventListener('click', ()=> { displayPrecision = 4; alert('Precision set to 4'); if(lastCalc) showResult(lastCalc); });
$('prec6').addEventListener('click', ()=> { displayPrecision = 6; alert('Precision set to 6'); if(lastCalc) showResult(lastCalc); });

/* ---------- Utility actions ---------- */
function deleteAllLocalData(){
  if(!confirm('Delete all saved trades and last calculation?')) return;
  localStorage.removeItem('fx_journal_v2'); sessionStorage.removeItem('fx_last_calc'); lastCalc = null;
  renderJournal(); $('resultArea').style.display='none';
  alert('Cleared local trade data.');
}

/* ---------- initialize ---------- */
function init(){
  // populate rates textarea
  $('ratesArea').value = JSON.stringify(fxRates, null, 2);
  // render journal
  renderJournal();
  // live updates
  setupLiveUpdates();
  // restore last calc
  const saved = sessionStorage.getItem('fx_last_calc');
  if(saved){ lastCalc = JSON.parse(saved); showResult(lastCalc); }
  // bind calculate on Enter key for numeric inputs
  ['balance','riskPercent','stopLoss','takeProfit','slippage','leverage'].forEach(id=>{
    $(id).addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); runCalcUI(); } });
  });

  // attach clear history by long-press (advanced)
  $('clearRates').addEventListener?.('click', ()=>{}); // noop fallback
}

/* expose some functions to window for inline onclicks (if used) */
window.runCalcUI = runCalcUI;
window.deleteTrade = deleteTrade;
window.downloadCalcPDF = downloadCalcPDF;
window.saveTrade = saveLastTrade;
window.clearHistory = deleteAllLocalData;

/* start */
init();

</script>
</body>
</html>
